<script language="JavaScript">
try {
if (location.href.search(/^http\:\/\/(?:\w+city|dungeon|kitezhgrad)\.combats\.com\/buttons\.pl\?battle=/)==0){
  if ("combats_plugins_manager" in this) {
    combats_plugins_manager.Configure();
  } else {
    var $A = Array.from = function(iterable) {
      if (!iterable) return [];
      var results = [];
      for (var i = 0, length = iterable.length; i < length; i++)
        results.push(iterable[i]);
      return results;
    };

    var create_object=function() {
      this.lastConfiguredPlugin = -1;
      this.security_id = %max_security_id;
      this.base_folder = external.m2_plugin_folder( this.security_id, "Combats.RU" );
    };

    create_object.prototype = {
      "events": {},
      "plugins_list": {},
      "plugins_disabled": {},
      "silent": true,
      "toString": function() {
        return " Combats.RU";
      },
      "getProperties": function() {
        var s = external.readFile( this.security_id, "Combats.RU", "combats_plugins.ini");
        while (s && !s.slice(-1).charCodeAt(0)) {
          s = s.slice(0,-1);
        }
        return [
          { name: "\"\"  ", value: this.silent },
          { name: "  ", value: this.loadCustomPlugin },
          { name: "  ", value: s, type:'textarea', style:"width:100%" }
        ];
      },
      "setProperties": function(a) {
        this.silent=a[0].value;
//        
//        var s = external.readFile( this.security_id, "Combats.RU", "combats_plugins.ini");
      },
      "attachEvent": function(event, method) {
        if (!(event in this.events))
          this.events[event] = [];
        this.events[event][this.events[event].length] = method;
      },
      "detachEvent": function(event, method) {
        if (event in this.events) {
          for (var i=0; i<this.events[event].length; i++)
            if (this.events[event][i] == method) {
              this.events[event].splice(i,1);
              break;
            }
        }
      },
      "fireEvent": function(event, eventObj) {
        if (event in this.events) {
          var i=0;
          try {
            for ( ; i<this.events[event].length; i++)
              this.events[event][i](eventObj);
          } catch(e) {
            e.event = event;
            e.index = i;
            this.logError('fireEvent',e);
          }
        }
      },
      "loadCustomPlugin": function() {
        var pluginName=prompt("   (   )","");
        if (pluginName=="")
          return;
        this.loadPlugin(pluginName);
      },

      "StartCfgPanelDrag": function() {
        if (window.event.srcElement.nodeName=='DIV' && !this.DragInfo) {
          var e = window.event;
          this.DragInfo = {
            MoveCfgPanelX: this.CfgDiv.offsetLeft,
            MoveCfgPanelY: this.CfgDiv.offsetTop,
	    MouseLeft: e.clientX-this.CfgDiv.offsetLeft,
	    MouseTop: e.clientY-this.CfgDiv.offsetTop
	  }
          document.attachEvent('onmousemove',this.DragCfgPanel);
          this.CfgDiv.style.cursor="move";
        }
      },
      "DragCfgPanel": function() {
        if (top.combats_plugins_manager.DragInfo) {
          var e = window.event;
          top.combats_plugins_manager.CfgDiv.style.left = e.clientX-top.combats_plugins_manager.DragInfo.MouseLeft+"px";
          top.combats_plugins_manager.CfgDiv.style.top = e.clientY-top.combats_plugins_manager.DragInfo.MouseTop+"px";
        }
      },
      "StopCfgPanelDrag": function() {
        this.DragInfo=null;
        document.detachEvent('onmousemove',this.DragCfgPanel);
        this.CfgDiv.style.cursor="auto";
      },
      "HideCfgPanel": function() {
        if (this.CfgDiv)
          document.body.removeChild(this.CfgDiv);
        this.CfgDiv = null;
        this.MoveCfgPanelMode=false; 
      },
      "Configure": function() {
        if (!this.CfgDiv) {
          var w;
          this.CfgDiv = document.createElement('<div>');
          this.CfgDiv.style.width = '600px';
          this.CfgDiv.style.height = '400px';
          this.CfgDiv.style.position = 'absolute';
          document.body.insertBefore(this.CfgDiv);
          this.CfgDiv.innerHTML = '<div style="width:100%; background:navy; text-align:right" oonmousemove="top.combats_plugins_manager.MoveCfgPanel()" oonmouseout="top.combats_plugins_manager.MoveCfgPanel()" onmousedown="top.combats_plugins_manager.StartCfgPanelDrag()" onmouseup="top.combats_plugins_manager.StopCfgPanelDrag()">\
<span style="cursor:pointer; color:white" onclick="top.combats_plugins_manager.HideCfgPanel()">&nbsp;X&nbsp;</span></div>\
<iframe style="width:100%; height:100%"></iframe>';
          w = this.CfgDiv.childNodes[1].contentWindow;
          w.document.write(external.readFile( this.security_id, "Combats.RU", "cfg.html"));
        }
        this.CfgDiv.style.left = (window.screen.width-600)/2;
        this.CfgDiv.style.top = (window.screen.height-400)/2;
      },

      "get_binded_method": function() { // object, method, ...
        var args = $A(arguments), object = args.shift(), __method = args.shift();
        return function() {
          return __method.apply(object, args.concat($A(arguments)));
        }
      },
      "addLog": function(message) {
        var s = external.readFile( this.security_id, "Combats.RU", "Combats.RU.log" );
        if (!s)
          s = '';
        s += message+"\n";
        external.writeFile( this.security_id, "Combats.RU", "Combats.RU.log", s );
      },
      "logError": function(plugin,e) {
        var messages = new Date().toLocaleString()+':    "'+plugin.toString()+'"<BR>';
        for(var i in e)
          messages += "&gt; ["+i+"]: "+e[i]+"<BR>";
        if (!this.silent) {
          this.add_chat(messages);
        }
        this.addLog(messages);
      },
      "loadPlugin": function(pluginName) {
        var d = (new Date()).toLocaleTimeString();
        var s = external.readFile( this.security_id, "Combats.RU", pluginName+"\\plugin.js");
        var errCount = 0;
        if (s!=null && s.length>0) {
          try {
            var obj = top.eval(s);
            if (obj)
              this.plugins_list[pluginName]=obj;
          } catch(e) {
            errCount++;
            var messages = '<font class=date2>'+d+'</font>    "'+pluginName+'"<BR>';
            for(var i in e)
              messages += '&gt; ['+i+']: '+e[i]+'<BR>';
            this.add_chat(messages);
            this.addLog(messages);
          }
        } else {
          var messages = '<font class=date2>'+d+'</font>  "'+pluginName+'"  :  "plugin.js"    ';
          this.add_chat(messages);
          this.addLog(messages);
        }
        return errCount;
      },
      getMainFrame: function() {
        return top.frames[3]; //   
      },
      getHTTPRequest: function() {
        if (top.XMLHttpRequest) {
          return new top.XMLHttpRequest();
        } else if (window.ActiveXObject) {
          return new ActiveXObject("Microsoft.XMLHTTP");
        }
        return null;
      },
      add_chat: function(s) {
        top.Chat.am(s);
      },
      Init: function() {
        try {
          var sleep = false;
          for(var i=0; i<top.frames.length; i++) {
            sleep |= (top.frames[i].document.readyState!="complete" && top.frames[i].document.readyState!="interactive");
          }
          if (sleep) {
            throw new Exception('Page is not ready');
          }
        } catch(e) {
          setTimeout(this.get_binded_method(this,this.Init),500);
          return;
        }

        var d = (new Date()).toLocaleTimeString();
        var s;
        if (true) {
          s = external.readFile( this.security_id, "Combats.RU", "combats_plugins.ini");
          if (!s) {
            s = external.readFile( this.security_id, "Combats.RU", "combats_plugins.ini.sample");
            external.writeFile( this.security_id, "Combats.RU", "combats_plugins.ini", s);
            this.add_chat('<font class=date2>'+d+'</font>   .    " "');
          }
          var combats_plugins = s.split(/[\x0A\x0D]+/);
        } else {
	  var combats_plugins = [];
	  var configuration = new ActiveXObject("Microsoft.XMLDOM");
	  configuration.loadXML(external.readFile(this.security_id, "Combats.RU", 'config.xml'));
	  if (configuration.parseError.errorCode != 0) {
	    var myErr = configuration.parseError;
	    alert(" :\n" + myErr.reason);
	  } else {
	    var root = configuration.documentElement;
	    this.user = root.selectSingleNode('user[@name="'+top.mylogin+'"]');
	    var plugins_names = this.user.selectNodes('profile[@name=//@loadprofile]/loadplugin/@name');
	    for(i=0;i<plugins_names.length;i++)
	      combats_plugins.push(plugins_names[i].nodeValue);
	  }
        }

        var errCount=0;
        this.plugins_list['combats_plugins_manager']=this;
        for(i=0;i<combats_plugins.length;i++) {
          s = combats_plugins[i].replace(/^\s*(.*?)\s*(?:[#;].*)?$/,'$1');
          if (s) {
            errCount += this.loadPlugin(s);
          }
        }
        if (errCount>0) {
          this.add_chat('<font class=date2>'+d+'</font>  : '+errCount);
        } else {
          this.add_chat('<font class=date2>'+d+'</font>   ');
        }
      }
    };
    combats_plugins_manager = new create_object();
    setTimeout(combats_plugins_manager.get_binded_method(combats_plugins_manager,combats_plugins_manager.Init),1500);
  }
}
} catch (e) {
}
</script>
